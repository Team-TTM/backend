const xlsx = require('xlsx');
const AdherentsModel = require('../models/repositories/adherentModel');
const Adherent = require('../models/entities/Adherent');
const {
    insertLicenceSaisonAssociation,
    saisonbyLicence
} = require('../models/repositories/licenceSaisonAssociationModel');
const {insertIfNotExists} = require('../models/repositories/saisonModel');
const {findUserByUserId} = require('./userService');
const {getSaisonPlusRecente} = require('../utils/saisonUtils');



/**
 * Charge les donn√©es √† partir d'un fichier Excel (XLSX).
 * @param {string} fichierXlsx - Le chemin vers le fichier Excel √† charger.
 * @returns {Object[]} - Retourne les donn√©es sous forme de tableau d'objets JSON repr√©sentant les lignes du fichier.
 */
function chargerDonneesExcel(fichierXlsx) {
    const workbook = xlsx.readFile(fichierXlsx);
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    return xlsx.utils.sheet_to_json(sheet);
}

/**
 * R√©cup√®re tous les adh√©rents de la base de donn√©es.
 * @returns {Promise<Object[Adherent]>} - Liste des adh√©rents.
 */
const getAllAdherents = async () => {
    try {
        console.log('üìå [SERVICE] R√©cup√©ration de tous les adh√©rents...');
        const adherents = await AdherentsModel.getAllAdherents();
        const adherentList = [];
        adherents.map(adherent => {
            adherentList.push(Adherent.fromDataBase(adherent));
        });

        console.log(`‚úÖ ${adherents.length} adh√©rents r√©cup√©r√©s.`);
        return adherentList;
    } catch (error) {
        console.error('‚ùå [SERVICE] Erreur lors de la r√©cup√©ration des adh√©rents:', error);
        throw error;
    }
};


/**
 * R√©cup√®re tous les adh√©rents li√©s √† un utilisateur donn√©.
 * @async
 * @function getAdherent
 * @param {string} userId - L'ID unique de l'utilisateur.
 * @returns {Promise<Adherent>} - Une promesse qui r√©sout un adh√©rent.
 * @throws {Error} - En cas d'√©chec de la r√©cup√©ration des adh√©rents.
 */
const getAdherent = async (userId) => {
    console.log(`üìå [SERVICE] D√©but de r√©cup√©ration des adh√©rents pour l'utilisateur ID: ${userId}...`);

    // Recherche de l'utilisateur
    const user = await findUserByUserId(userId);
    if (!user) {
        throw new Error(`Utilisateur introuvable pour l'ID: ${userId}`);
    }
    if (!user.numero_licence) {
        throw new Error(`Num√©ro de licence manquant pour l'utilisateur ID: ${userId}`);
    }

    console.log(`üîç [SERVICE] Utilisateur trouv√©: ${userId}, Licence: ${user.numero_licence}`);

    // R√©cup√©ration des adh√©rents
    const adherentData = await AdherentsModel.getAdherentDetails(user.numero_licence);
    if (!adherentData || adherentData.length === 0) {
        console.warn(`‚ö†Ô∏è [SERVICE] Aucun adh√©rent trouv√© pour l'utilisateur ${user.numero_licence}`);
        return [];
    }

    // Conversion en objets Adherent
    const adherents = Adherent.fromDataBase(adherentData);

    console.log(`‚úÖ [SERVICE] ${adherents.length} adh√©rent(s) r√©cup√©r√©(s) pour l'utilisateur ${user.numero_licence}`);
    return adherents;
};

/**
 * Cr√©e un nouvel adh√©rent dans la base de donn√©es via le mod√®le AdherentsModel.
 * @param {Adherent} adherent - L'objet Adherent √† ins√©rer dans la base de donn√©es.
 * @returns {Promise} - Une promesse qui se r√©sout lorsque l'adh√©rent est cr√©√©.
 */
const createAdherent = async (adherent) => {
    await Promise.all([
        AdherentsModel.createAdherent(adherent),
        insertIfNotExists(adherent.getDerniereSaison())
    ]);
    await insertLicenceSaisonAssociation(adherent.getDerniereSaison(), adherent.numeroLicence);
};

/**
 * Met √† jour un adh√©rent existant dans la base de donn√©es.
 * @param {Adherent} adherent - Les nouvelles donn√©es de l'adh√©rent √† mettre √† jour.
 * @returns {Promise<Boolean>} - Une promesse indiquant le succ√®s ou l'√©chec de la mise √† jour.
 */
const updateAdherent = async (adherent) => {
    const saisonData = await saisonbyLicence(adherent.numeroLicence);
    const saison = [];
    saisonData.map(id => {
        saison.push(id.saison_id);
    });
    if (!saison.includes(adherent.getDerniereSaison())) {
        await insertIfNotExists(adherent.getDerniereSaison());
        if (getSaisonPlusRecente(saison) < adherent.saison) {
            await Promise.all([
                insertLicenceSaisonAssociation(adherent.getDerniereSaison(), adherent.numeroLicence),
                AdherentsModel.updateAdherent(adherent)
            ]);
        } else {
            await insertLicenceSaisonAssociation(adherent.getDerniereSaison(), adherent.numeroLicence);
        }
        return true;
    } else {
        return false;
    }
};

/**
 * Transforme les donn√©es provenant d'un fichier Excel en une liste d'objets Adherent.
 * @param {Object[]} donnees - Le tableau de donn√©es extrait du fichier Excel.
 * @returns {Promise<Adherent[]>} - Une promesse qui se r√©sout avec un tableau d'objets Adherent.
 */
async function transformerDonneesEnAdherents(donnees) {
    const adherents = [];
    for (const row of donnees) {
        adherents.push(Adherent.fromXslx(row));
    }
    return adherents;
}

/**
 * Importe les donn√©es √† partir d'un fichier Excel et les ins√®re dans la base de donn√©es.
 * @param {string} fichierXlsx - Le chemin vers le fichier Excel √† importer.
 * @returns {Promise<Object|null>} - Une promesse qui se r√©sout apr√®s l'importation compl√®te des donn√©es.
 * @throws {Error}
 */
async function importerXlsx(fichierXlsx) {
    console.log('üìÇ Chargement du fichier Excel...');
    const donnees = chargerDonneesExcel(fichierXlsx);
    console.log('üîÑ Conversion des donn√©es..');
    const adherents = await transformerDonneesEnAdherents(donnees);
    console.log('üõ†Ô∏è Importation des donn√©es dans la base de donn√©es...');

    let ajoutCount = 0;
    let majCount = 0;

    for (const adherent of adherents) {
        const exist = await checkAdherentLicence(adherent.numeroLicence);
        if (exist) {
            const isupdate = await updateAdherent(adherent);
            if (isupdate) {
                majCount++;
            }
        } else {
            await createAdherent(adherent);
            ajoutCount++;
        }
    }
    console.log(`‚úÖ Importation termin√©e avec succ√®s. ${ajoutCount} documents ajout√©s, ${majCount} documents mis √† jour.`);
    return {add: ajoutCount, update: majCount};
}


/**
 * V√©rifie si un adh√©rent existe en base de donn√©es.
 * @param {string} num_licence - Le num√©ro de licence de l'adh√©rent.
 * @returns {Promise<boolean>} - Retourne `true` si l'adh√©rent existe, sinon `false`.
 */
async function checkAdherentLicence(num_licence) {
    return AdherentsModel.adherentExist(num_licence);
}

const editAdherent = async (adherent) => {
    return await AdherentsModel.updateAdherent(adherent);
};
module.exports = {importerXlsx, checkAdherentLicence, getAllAdherents, getAdherent, updateAdherent, editAdherent};
